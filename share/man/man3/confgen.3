.TH CONFGEN 3 "2024\-03\-22"
.SH NAME
.B Confgen API
\- the
.I Lua API
of the
.I Confgen
template engine.

.SH SYNOPSIS
The
.B Confgen API
is exposes 2 main objects: the global
.IR cg ,
providing the main interface to confgen and the global
.IR tmpl ,
only inside templates for template-specific operations.

.SH DESCRIPTION

All relative paths handled by the API are treated as local to the directory the
.I confgenfile
is in.

The fields on the globals are as follows:

.TP
.B cg.opt
This field is where the user is encouraged to define shared vaules to be used across templates.
The value is pre-initialized to an
.IR empty\ table .

Example:
.B cg.opt.font = \(dqMyFont\(dq

.TP
.B cg.addString(outpath, data[, copy])
Add a configuration file
.I outpath
to the file list, its content being defined by
.IR data .
The
.I copy
argument may optionally be set to a boolean value, defaulting to
.IR false .
If
.I copy
is equal to
.IR true ,
the
.I data
argument will be directly written to the output file, otherwise, it is interpreted as a
.IR template .

Example:
.B cg.addString(\(dq.config/example\(dq, \(dqkey = value\(dq)

.TP
.B cg.addPath(path[, targpath])
Recursively add all files in the
.I target directory
to the file list.
If
.I targpath
is provided, it will be used as the prefix directory in the file list, otherwise
.I path
is used.

Example:
.B cg.addPath(\(dq.config\(dq)

.TP
.B cg.addFile(inpath[, outpath])
Adds a single file, located at
.I inpath
to the file list under the name
.IR outpath .
If
.I outpath
is omitted, it will use the same value as
.IR inpath .

Example:
.B cg.addFile(\(dq.gtkrc-2.0\(dq)

.TP
.B cg.doTemplate(source[, opt])
Load some template code and immediately evaluate it, returning the resulting data as a string.
The
.I opt
argument may optionally be provided. It may have 2 fields, both of which are optional: The
.I opt
field will be used for the template's option table instead of
.I cg.opt
and the
.I name
field will set a name for the source chunk, defaulting to
.BR <dotemplate> .

Example:
.B local my_data = cg.doTemplate(\(dq<% 2 * 2 %>\(dq) -- \(dq4\(dq

.TP
.B cg.doTemplateFile(inpath[, opt])
Identical to
.IR doTemplate ,
except that the template data is read from a given file and that the
.I name
option is not supported.

Example:
.B local generated = cg.doTemplateFile("path/to/template.cgt", { opt = { foo = bar } })

.TP
.B cg.onDone(callback)
Add a callback function to be ran when confgen finishes. The
.I callback
argument must be a Lua function. Confgen will call this function when it finishes. This function will
be provided a single argument:
.I true
if errors where encountered, or
.I false
if there were none. Multiple callbacks may be added.

This may be useful to, for example, run commands to update system state after a successful run as is
commonly required when using stateful tools such as
.IR gsettings .

ConfgenFS will never call callbacks registered with
.IR onDone .

Example:
.B cg.onDone(function(errors) print(\(dqHad errors: \(dq .. tostring(errors)) end)

.TP
.B cg.fs
A table only present under ConfgenFS. It contains the following fields:

.IP \(bu
The
.I mountpoint
field will contain a path to the mountpoint of the filesystem. This is an absolute path unless
ConfgenFS failed to resolve it, in which case it will be as provided on the command line.

.TP
.B cg.fmt.json.serialize(value[, pretty])
Convert an arbitrary lua value to JSON and return that as a string. The JSON will be minified by
default unless
.IR pretty \ is \ true .

Unrepresentable Lua values such as
.I functions
will be serialized as
.IR null .

Example:
.B local json = cg.fmt.json.serialize({ x = \(dqy\(dq }) -- '{\(dqx\(dq: \(dqy\(dq}'

.TP
.B cg.fileIter()
Obtain an
.I iterator function
over the files that have been added to confgen. Upon each invocation, it will return a table with
the following fields:

.IP \(bu
The
.I path
field will contain the path of the output file relative to the 
.IR destination\ directory .

.IP \(bu
The
.I copy
field will be set to
.I true
if the file is not a template and will be simply copied to the destination and
.I false
if the file is a template and will have generation done first.

.IP \(bu
The
.I content
field will be a table, either containing the file's source code in its
.I string
field, or the path to the source file in its
.I path
field.

.TP
.B tmpl
The global value
.I tmpl
will be set to a seperate value in every template. It's a data structure that collects the final
output of the template and also stores some properties of the final, generated code.

A template is generated by pushing data to it, which is appended to the output. See 
.BR confgen-template (5).

.TP
.B tmpl:pushLitIdx(tmplcode, n)
This function is called internally in order to push literal code defined in the template source to
the output buffer. Do not call this manually unless you want broken output!
The tmplcode is a magic object used internally to store the source code of the template.
It does not have any functionality usable by the end user.

Example:
.B NO!

.TP
.B tmpl:pushValue(value)
Push a Lua value to the output buffer. The values will be converted to strings the same as Lua's
.I tostring
would, except that
.I nil
is ignored and nothing is appended. This function is rarely called manually and is instead what
.I Confgen
generates for
.IR Lua\ expression\ blocks .

Example:
.B tmpl:pushValue(2 + 2) -- equivalent to: <% 2 + 2 %>

.TP
.B tmpl:setPostProcessor(postprocessor)
Sets the
.I postprocessor function
for this template. The given function will be called by
.I Confgen
after the template has been fully generated with the entire 
.I output buffer
as an
.IR argument .
It may do any arbitrary transformations on the data and 
.I return
it as a
.IR string ,
which confgen will emit in place of the original output buffer.

Example:
.B tmpl:setPostProcessor(function(data) return string.upper(data) end) -- convert all characters to upper case

.TP
.B tmpl:setMode(filemode)
Set the file mode of the output file. If this is never called, output files will have the mode
.IR 644 .
This function may either be called with an integer to directly interpret as a file mode or a string
which will be parsed in
.I octal
to such an integer. Be careful not to mistakenly call it with a decimal number \-
.B tmpl:setMode(755) is INVALID!

Example:
.B tmpl:setMode("755") -- Make file executable

.TP
.B tmpl:setAssumeDeterministic(assume_deterministic)
Tell
.I ConfgenFS
that this template does not change when repeatedly evaluated. This causes
.I ConfgenFS
to report the size of the file's last evaluation when
.I fstat
is invoked.

Example:
.B tmpl:setAssumeDeterministic(true) -- File does not change; ConfgenFS reports size

.TP
.B tmpl:subtmpl(func)
Call the passed-in function with a new
.I Template
object and return the output.

This is useful in cases where a section of the template should be processed differently than the rest, for example using a custom post-processor.
The passed-in function
.B must
take an argument called
.BR tmpl .
Other variable names are usually not handled correctly here!

Example:
.B <! local output = tmpl:subtmpl(function(tmpl) !> ... <! end) !>

.TP
.B tmpl:pushSubtmpl(func)
Like
.IR subtmpl ,
but the output of the subtemplate is pushed to this template rather than returned.
This is useful if all special processing for the given template is done by a
.I post-processor
rather than the caller code.

Example:
.B <! tmpl:pushSubtmpl(function(tmpl) !> ... <! end) !>

.SH SEE ALSO
.BR confgen (1),
.BR confgen.lua (5),
.BR confgen-template (5),
.BR confgenfs (1).
